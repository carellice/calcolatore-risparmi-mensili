<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Bulldog (Material - Storico)</title>
    <link rel="icon" href="https://i.ibb.co/Nd1mmfK0/Minimalist-Material-Design-web-app-icon-featuring-a-stylized-bulldog-head-front-view-The-head-is-a.png" type="image/png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/Nd1mmfK0/Minimalist-Material-Design-web-app-icon-featuring-a-stylized-bulldog-head-front-view-The-head-is-a.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

    <style>
        /* --- Material Design CSS Variables --- */
        :root {
            --font-family: 'Roboto', sans-serif;
            --border-radius: 15px; /* Aumentato per angoli pi√π tondi (come richiesto) */
            --spacing-xs: 4px;
            --spacing-s: 8px;
            --spacing-m: 16px;
            --spacing-l: 24px;
            --spacing-xl: 32px;

            /* Light Theme Palette (Example: Blue & Amber) */
            --md-primary: #1976D2; /* Blue 700 */
            --md-primary-dark: #0D47A1; /* Blue 900 */
            --md-primary-light: #64B5F6; /* Blue 300 */
            --md-accent: #FFAB00; /* Amber A400 */
            --md-text-primary: rgba(0, 0, 0, 0.87);
            --md-text-secondary: rgba(0, 0, 0, 0.60);
            --md-text-disabled: rgba(0, 0, 0, 0.38);
            --md-divider: rgba(0, 0, 0, 0.12);
            --md-background: #F5F5F5; /* Grey 100 */
            --md-surface: #FFFFFF; /* Card background */
            --md-error: #D32F2F; /* Red 700 */
            --md-on-primary: #FFFFFF;
            --md-on-secondary: #FFFFFF;
            --md-on-accent: rgba(0,0,0,0.87); /* Text on accent */
            --md-on-surface: rgba(0, 0, 0, 0.87);
            --md-on-error: #FFFFFF;
            --md-input-fill: rgba(0, 0, 0, 0.06); /* Filled input background */
            --md-input-border-hover: rgba(0, 0, 0, 0.42);
            --md-input-border-focus: var(--md-primary);
             --md-mascot-fill: #8D6E63; /* Brown 400 */

            /* Elevations (Box Shadows) */
            --elevation-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --elevation-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --elevation-4: 0 4px 8px rgba(0,0,0,0.19), 0 3px 6px rgba(0,0,0,0.23); /* App Bar */
            --elevation-8: 0 8px 17px rgba(0,0,0,0.2), 0 6px 6px rgba(0,0,0,0.23); /* Raised button hover */
        }

        body.dark-mode {
             /* Dark Theme Palette */
            --md-primary: #90CAF9; /* Blue 200 */
            --md-primary-dark: #64B5F6; /* Blue 300 */
            --md-primary-light: #E3F2FD; /* Blue 50 */
            --md-accent: #FFD180; /* Amber A100 */
            --md-text-primary: rgba(255, 255, 255, 0.87);
            --md-text-secondary: rgba(255, 255, 255, 0.60);
            --md-text-disabled: rgba(255, 255, 255, 0.38);
            --md-divider: rgba(255, 255, 255, 0.12);
            --md-background: #121212; /* Standard dark background */
            --md-surface: #1E1E1E; /* Card background (slightly lighter dark) */
            --md-error: #EF9A9A; /* Red 200 */
            --md-on-primary: rgba(0, 0, 0, 0.87); /* Text on light primary */
            --md-on-secondary: rgba(0, 0, 0, 0.87);
            --md-on-accent: rgba(0,0,0,0.87);
            --md-on-surface: rgba(255, 255, 255, 0.87);
            --md-on-error: rgba(0, 0, 0, 0.87);
             --md-input-fill: rgba(255, 255, 255, 0.09);
             --md-input-border-hover: rgba(255, 255, 255, 0.7);
             --md-input-border-focus: var(--md-primary);
             --md-mascot-fill: #BCAAA4; /* Brown 200 */

             /* Dark Elevations (subtler shadows, often rely on surface brightness) */
            --elevation-1: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.4); /* Darker shadows */
            --elevation-2: 0 3px 6px rgba(0,0,0,0.3), 0 3px 6px rgba(0,0,0,0.4);
            --elevation-4: 0 4px 8px rgba(0,0,0,0.4), 0 3px 6px rgba(0,0,0,0.4);
            --elevation-8: 0 8px 17px rgba(0,0,0,0.5), 0 6px 6px rgba(0,0,0,0.4);
        }

        /* --- Base Styles --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px; /* Base font size */
             scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--md-background);
            color: var(--md-text-primary);
            line-height: 1.5; /* Material default */
            transition: background-color 0.3s ease, color 0.3s ease;
            padding-top: 72px; /* Space for fixed AppBar (56px + padding) */
            padding-bottom: var(--spacing-xl);
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 500; /* Medium weight for headers */
        }

        /* --- Layout & Containers --- */
        .app-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 var(--spacing-m);
        }

        .app-bar {
            background-color: var(--md-primary);
            color: var(--md-on-primary);
            padding: var(--spacing-s) var(--spacing-m);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--elevation-4);
            position: fixed; /* Fixed App Bar */
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            height: 56px; /* Standard height */
        }

        .app-bar h1 {
            font-size: 1.25rem; /* 20sp */
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--spacing-s);
        }

        .mascot { /* Applied to IMG or SVG */
            width: 32px;
            height: 32px;
            fill: var(--md-mascot-fill); /* Fill for SVG */
            background-color: var(--md-on-primary); /* Circle behind mascot (IMG/SVG) */
            padding: 2px;
            border-radius: 50%;
            object-fit: contain; /* Helps if PNG is not square */
        }

        /* --- Material Icon Button --- */
        .btn-icon {
            background-color: transparent;
            border: none;
            border-radius: 50%;
            padding: var(--spacing-s); /* 8dp padding for 40dp touch target */
            cursor: pointer;
            color: var(--md-on-primary); /* Icon color on primary background */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            outline: none;
            position: relative;
            overflow: hidden; /* For ripple */
             transition: background-color 0.2s ease;
        }
         .btn-icon:hover {
            background-color: rgba(255, 255, 255, 0.1); /* Subtle hover for dark icons */
         }
         body.dark-mode .btn-icon:hover {
             background-color: rgba(0, 0, 0, 0.1); /* Subtle hover for light icons */
         }

        .btn-icon .material-symbols-outlined {
            font-size: 24px; /* Standard icon size */
            pointer-events: none; /* Prevent icon stealing clicks */
        }


        /* --- Cards --- */
        .card {
            background-color: var(--md-surface);
            color: var(--md-on-surface);
            border-radius: var(--border-radius); /* Usa la variabile aggiornata (15px) */
            padding: var(--spacing-l);
            margin-bottom: var(--spacing-l);
            box-shadow: var(--elevation-1);
            transition: background-color 0.3s ease, box-shadow 0.2s ease;
        }
        .card:hover {
             /* Optional: slightly raise card on hover */
             /* box-shadow: var(--elevation-2); */
        }

        .card h2 {
            font-size: 1.25rem; /* 20sp */
            font-weight: 500;
            margin-bottom: var(--spacing-m);
            padding-bottom: var(--spacing-s);
             border-bottom: 1px solid var(--md-divider);
            color: var(--md-primary); /* Use primary color for header */
        }
        body.dark-mode .card h2 {
            color: var(--md-primary-light);
        }

        /* --- Forms & Text Fields (Simulated Filled Style) --- */
        .form-group {
            /* Imposta lo spazio verticale tra i gruppi di input/label */
            margin-bottom: var(--spacing-l); /* Spazio standard (24px) tra i fieldset */
            position: relative;
        }

        /* Label sopra l'input */
        .form-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-size: 0.75rem; /* 12sp */
            color: var(--md-text-secondary);
            padding-left: var(--spacing-m); /* Align with input padding */
        }

        .text-field-container {
             background-color: var(--md-input-fill);
             border-top-left-radius: var(--border-radius); /* Usa la variabile aggiornata (15px) */
             border-top-right-radius: var(--border-radius); /* Usa la variabile aggiornata (15px) */
             padding: var(--spacing-s) var(--spacing-m); /* Padding standard dentro il campo */
             border-bottom: 1px solid var(--md-input-border-hover);
             transition: border-color 0.2s ease, background-color 0.3s ease;
             position: relative;
             overflow: hidden;
        }
        .text-field-container:hover {
            border-bottom-color: var(--md-text-primary);
        }
        .text-field-container input:focus + .underline {
             transform: scaleX(1);
        }


         input[type="text"],
         input[type="number"],
         input[type="password"],
         input[type="file"],
         select {
             display: block;
             width: 100%;
             padding: var(--spacing-s) 0; /* Padding verticale dentro l'input effettivo */
             border: none;
             background-color: transparent; /* Input √® trasparente */
             color: var(--md-on-surface);
             font-size: 1rem; /* 16sp */
             outline: none;
             line-height: 1.5;
             appearance: none; /* Remove default styling */
             border-radius: 0; /* Assicurati che l'input stesso non sia arrotondato */
         }
         /* Style select arrow */
         select {
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23${(getComputedStyle(document.documentElement).getPropertyValue('--md-text-secondary') || '000000').substring(1)}'%3E%3Cpath d='M7 10l5 5 5-5H7z'/%3E%3C/svg%3E");
             background-repeat: no-repeat;
             background-position: right var(--spacing-m) center;
             background-size: 1.5em;
             padding-right: calc(var(--spacing-m) * 2 + 1.5em); /* Make space for arrow */
         }

         /* Underline for focus indicator */
         .underline {
             position: absolute;
             bottom: 0;
             left: 0;
             right: 0;
             height: 2px;
             background-color: var(--md-input-border-focus);
             transform: scaleX(0);
             transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
         }

         /* Basic file input styling */
         input[type="file"] {
            color: var(--md-text-secondary);
            padding: var(--spacing-s) 0;
         }
         input[type="file"]::file-selector-button {
             padding: var(--spacing-xs) var(--spacing-s);
             border: 1px solid var(--md-divider);
             border-radius: var(--border-radius); /* Usa la variabile aggiornata (15px) */
             background-color: var(--md-surface);
             color: var(--md-primary);
             font-weight: 500;
             cursor: pointer;
             margin-right: var(--spacing-m);
         }
         input[type="file"]::file-selector-button:hover {
            background-color: rgba(0,0,0,0.04);
         }
         body.dark-mode input[type="file"]::file-selector-button {
            background-color: var(--md-input-fill);
            border-color: var(--md-divider);
            color: var(--md-primary-light);
         }
          body.dark-mode input[type="file"]::file-selector-button:hover {
             background-color: rgba(255,255,255,0.1);
          }


        /* --- Buttons --- */
        .btn {
            display: inline-block;
            min-width: 64px;
            padding: 0 var(--spacing-m);
            height: 36px;
            line-height: 36px;
            border: none;
            border-radius: var(--border-radius); /* Usa la variabile aggiornata (15px) */
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.089em;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            outline: none;
            vertical-align: middle;
            margin-right: var(--spacing-s);
            margin-top: var(--spacing-s);
            position: relative;
            overflow: hidden;
        }

        /* Ripple Effect Placeholder */
        .btn::after { content: ''; position: absolute; top: 50%; left: 50%; width: 5px; height: 5px; background: rgba(255, 255, 255, 0.3); opacity: 0; border-radius: 100%; transform: scale(1, 1) translate(-50%); transform-origin: 50% 50%; }
        .btn:focus:not(:active)::after { animation: ripple-focus 1s ease-out infinite; }
        .btn:active::after { animation: ripple 0.5s ease-out; }
        body.dark-mode .btn::after { background: rgba(0, 0, 0, 0.2); }
        @keyframes ripple { 0% { transform: scale(0, 0) translate(-50%); opacity: 1; } 100% { transform: scale(20, 20) translate(-50%); opacity: 0; } }
        @keyframes ripple-focus { 0% { transform: scale(1, 1) translate(-50%); background: rgba(255, 255, 255, 0.1); opacity: 1; } 50% { transform: scale(1.2, 1.2) translate(-50%); background: rgba(255, 255, 255, 0.15); opacity: 0.5; } 100% { transform: scale(1, 1) translate(-50%); background: rgba(255, 255, 255, 0.1); opacity: 1; } }
        body.dark-mode @keyframes ripple-focus { 0% { transform: scale(1, 1) translate(-50%); background: rgba(0, 0, 0, 0.1); opacity: 1; } 50% { transform: scale(1.2, 1.2) translate(-50%); background: rgba(0, 0, 0, 0.15); opacity: 0.5; } 100% { transform: scale(1, 1) translate(-50%); background: rgba(0, 0, 0, 0.1); opacity: 1; } }

        /* Raised Button */
        .btn-raised { box-shadow: var(--elevation-2); background-color: var(--md-primary); color: var(--md-on-primary); }
        .btn-raised:hover { box-shadow: var(--elevation-4); background-color: var(--md-primary-dark); }
        .btn-raised:active { box-shadow: var(--elevation-8); }
         .btn-raised.btn-secondary { background-color: var(--md-accent); color: var(--md-on-accent); }
         .btn-raised.btn-secondary:hover { background-color: #FFA000; } /* Amber 700 approx */
         .btn-raised.btn-danger { background-color: var(--md-error); color: var(--md-on-error); }
         .btn-raised.btn-danger:hover { background-color: #C62828; } /* Red 800 approx */

         /* Outlined Button */
         .btn-outline { background-color: transparent; border: 1px solid var(--md-divider); color: var(--md-primary); padding: 0 calc(var(--spacing-m) - 1px); }
         .btn-outline:hover { background-color: rgba(var(--md-primary-rgb, 25, 118, 210), 0.04); border-color: var(--md-primary); }
         body.dark-mode .btn-outline:hover { background-color: rgba(var(--md-primary-rgb-dark, 144, 202, 249), 0.08); border-color: var(--md-primary); }
          .btn-outline.btn-danger { color: var(--md-error); border-color: var(--md-error); }
          .btn-outline.btn-danger:hover { background-color: rgba(var(--md-error-rgb, 211, 47, 47), 0.04); }
          body.dark-mode .btn-outline.btn-danger { border-color: var(--md-error); color: var(--md-error); }
           body.dark-mode .btn-outline.btn-danger:hover { background-color: rgba(var(--md-error-rgb-dark, 239, 154, 154), 0.08); }

         /* Text Button (for sorting) */
         .btn-text { background-color: transparent; color: var(--md-primary); min-width: auto; padding: 0 var(--spacing-s); }
         .btn-text:hover { background-color: rgba(var(--md-primary-rgb, 25, 118, 210), 0.04); }
         body.dark-mode .btn-text:hover { background-color: rgba(var(--md-primary-rgb-dark, 144, 202, 249), 0.08); }
          .btn-text.active { background-color: rgba(var(--md-primary-rgb, 25, 118, 210), 0.12); font-weight: 700; }
           body.dark-mode .btn-text.active { background-color: rgba(var(--md-primary-rgb-dark, 144, 202, 249), 0.16); }


        /* --- Summary Section --- */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--spacing-m); text-align: center; }
        .summary-item { background-color: var(--md-input-fill); padding: var(--spacing-m); border-radius: var(--border-radius); /* Usa la variabile aggiornata (15px) */ color: var(--md-on-surface); }
        .summary-item h3 { font-size: 0.875rem; color: var(--md-text-secondary); margin-bottom: var(--spacing-xs); font-weight: 400; }
        .summary-item p { font-size: 1.5rem; font-weight: 500; color: var(--md-primary); }
        body.dark-mode .summary-item p { color: var(--md-primary-light); }
         .summary-item p.negative { color: var(--md-error); }


        /* --- Lists & Tables --- */
        .item-list { list-style: none; padding: 0; margin-top: var(--spacing-m); }
        .item-list li { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: var(--spacing-m) 0; border-bottom: 1px solid var(--md-divider); min-height: 56px; }
        .item-list li:last-child { border-bottom: none; }
        .item-list .item-details { flex-grow: 1; margin-right: var(--spacing-m); padding-bottom: var(--spacing-xs); }
        .item-list .item-name { font-weight: 500; font-size: 1rem; color: var(--md-text-primary); }
         .item-list .item-category { font-size: 0.875rem; color: var(--md-text-secondary); margin-left: var(--spacing-s); display: inline-block; }
        .item-list .item-amount { font-weight: 500; font-size: 1rem; min-width: 80px; text-align: right; color: var(--md-text-primary); margin-left: auto; padding-left: var(--spacing-m); }
         .item-list .btn-delete-item { background-color: transparent; border: none; border-radius: 50%; padding: var(--spacing-xs); cursor: pointer; color: var(--md-text-secondary); display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; margin-left: var(--spacing-s); transition: background-color 0.2s ease, color 0.2s ease; flex-shrink: 0; }
         .item-list .btn-delete-item:hover { background-color: rgba(var(--md-error-rgb, 211, 47, 47), 0.1); color: var(--md-error); }
          body.dark-mode .item-list .btn-delete-item:hover { background-color: rgba(var(--md-error-rgb-dark, 239, 154, 154), 0.15); }
         .item-list .btn-delete-item .material-symbols-outlined { font-size: 20px; }

        .list-total { text-align: right; margin-top: var(--spacing-m); font-size: 1.1rem; font-weight: 500; padding-top: var(--spacing-m); border-top: 1px solid var(--md-divider); color: var(--md-text-secondary); }
         .list-total span { font-weight: 700; color: var(--md-text-primary); }

        .category-subtotal { margin-top: var(--spacing-m); padding-top: var(--spacing-s); border-top: 1px dashed var(--md-divider); }
        .category-subtotal h4 { font-size: 0.875rem; font-weight: 700; margin-bottom: var(--spacing-xs); color: var(--md-text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        .category-subtotal .item-list { margin-top: 0; }
        .category-subtotal-amount { text-align: right; font-weight: 500; font-size: 0.875rem; margin-top: var(--spacing-s); color: var(--md-text-secondary); }
         .category-subtotal-amount span { font-weight: 700; color: var(--md-text-primary); }

        /* --- Sorting Controls --- */
        .sort-controls { margin-bottom: var(--spacing-m); padding-bottom: var(--spacing-m); border-bottom: 1px solid var(--md-divider); display: flex; align-items: center; gap: var(--spacing-s); flex-wrap: wrap; }
        .sort-controls span { font-weight: 500; margin-right: var(--spacing-s); font-size: 0.875rem; color: var(--md-text-secondary); }
         .sort-controls .btn-text { margin: 0; }


        /* --- Snackbar Notification --- */
        #notification { position: fixed; bottom: var(--spacing-l); left: var(--spacing-l); background-color: #323232; color: rgba(255, 255, 255, 0.87); padding: var(--spacing-m) var(--spacing-l); border-radius: var(--border-radius); /* Usa la variabile aggiornata (15px) */ box-shadow: var(--elevation-4); z-index: 1000; opacity: 0; transform: translateY(100%); transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none; font-size: 0.875rem; max-width: calc(100% - var(--spacing-l) * 2); }
        #notification.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
         #notification.error { background-color: var(--md-error); color: var(--md-on-error); }
         #notification.success { background-color: #4CAF50; color: #FFFFFF; }

        /* --- Responsiveness --- */
        @media (max-width: 768px) {
             body { padding-top: 64px; }
             .app-bar { height: 56px; }
             .app-bar h1 { font-size: 1.125rem; }
             .card { padding: var(--spacing-m); }
             .summary-grid { grid-template-columns: 1fr 1fr; }

             /* Rimosse regole per #form-id > div { flex-direction: column; } */
             /* Rimosse regole specifiche per #form-id .form-group { margin-bottom: ... } dentro questa media query */
             /* La spaziatura verticale √® ora gestita dalla regola globale .form-group */

             /* Riduci padding interno dei campi di testo su mobile per compattezza */
             /* Manteniamo questo perch√© migliora la densit√† su mobile */
             #main-income-form .text-field-container,
             #fixed-expense-form .text-field-container,
             #extra-income-form .text-field-container,
             #debt-form .text-field-container {
                 padding-top: var(--spacing-xs);    /* 4px */
                 padding-bottom: var(--spacing-xs); /* 4px */
             }
        }

        @media (max-width: 480px) {
             html { font-size: 15px; }
             body { padding-top: 56px; }
             .app-container { padding: 0 var(--spacing-s); }
             .card { padding: var(--spacing-m); margin-bottom: var(--spacing-m); }
             .summary-grid { grid-template-columns: 1fr; }
             .btn { width: 100%; margin-right: 0; margin-bottom: var(--spacing-m); }
             .btn-icon, .sort-controls .btn-text, .item-list .btn-delete-item { width: auto; margin-bottom: var(--spacing-s); /* Reset margin bottom for inline buttons */ }
             .sort-controls { justify-content: center; }
             #notification { left: var(--spacing-m); bottom: var(--spacing-m); width: calc(100% - var(--spacing-m) * 2); }
             .item-list .item-details { width: calc(100% - 50px); margin-right: var(--spacing-s); }
             .item-list .item-amount { padding-left: var(--spacing-s); }
             .item-list .btn-delete-item { margin-left: var(--spacing-xs); }

             /* Assicurati che il margine globale si applichi anche qui */
             /* La regola globale .form-group { margin-bottom: var(--spacing-l); } √® sufficiente */
             /* .form-group { margin-bottom: var(--spacing-l); } */ /* Non serve ripetere se globale √® gi√† --spacing-l */
        }

        /* Helper to get RGB values for rgba backgrounds */
        :root { --md-primary-rgb: 25, 118, 210; --md-error-rgb: 211, 47, 47; }
        body.dark-mode { --md-primary-rgb-dark: 144, 202, 249; --md-error-rgb-dark: 239, 154, 154; }

    </style>
</head>
<body>

    <header class="app-bar">
        <h1>
            <img src="https://i.ibb.co/Nd1mmfK0/Minimalist-Material-Design-web-app-icon-featuring-a-stylized-bulldog-head-front-view-The-head-is-a.png" alt="Icona Budget Bulldog" class="mascot">
            <span>Budget Bulldog</span>
        </h1>
        <button class="btn-icon" id="theme-switcher" title="Cambia Tema">
            <span class="material-symbols-outlined" id="theme-icon">light_mode</span>
        </button>
    </header>

    <div class="app-container">

        <main>
            <section class="card">
                <h2>Riepilogo Mensile (<span id="current-month-display"></span>)</h2>
                <div class="summary-grid">
                    <div class="summary-item">
                        <h3>üí∞ Entrate Princ. Tot.</h3> <p id="summary-salary">‚Ç¨ 0.00</p>
                    </div>
                     <div class="summary-item">
                        <h3>üè¶ Risparmio Prev.</h3>
                        <p id="summary-savings-goal">‚Ç¨ 0.00</p>
                    </div>
                     <div class="summary-item">
                        <h3>üí∏ Spese Fisse Tot.</h3>
                        <p id="summary-fixed-total">‚Ç¨ 0.00</p>
                    </div>
                    <div class="summary-item">
                        <h3>‚ûï Entrate Extra</h3>
                        <p id="summary-extra-income">‚Ç¨ 0.00</p>
                    </div>
                     <div class="summary-item">
                        <h3>üìâ Debiti Mese Prec.</h3>
                        <p id="summary-prev-debt">‚Ç¨ 0.00</p>
                    </div>
                     <div class="summary-item">
                        <h3>‚úÖ Spendibile</h3>
                        <p id="summary-spendable">‚Ç¨ 0.00</p>
                    </div>
                </div>
            </section>

             <section class="card">
                <h2>üéØ Obiettivi Mensili</h2>
                <form id="goals-form">
                     <div class="form-group">
                        <label for="savings-goal">Quanto vuoi Risparmiare questo mese (‚Ç¨)</label>
                         <div class="text-field-container">
                            <input type="number" id="savings-goal" step="0.01" min="0" required> <div class="underline"></div>
                         </div>
                    </div>
                     <div class="form-group">
                        <label for="immediate-deduction">Importo da "Mettere da Parte" subito (‚Ç¨)</label>
                         <div class="text-field-container">
                            <input type="number" id="immediate-deduction" step="0.01" min="0" required> <div class="underline"></div>
                         </div>
                         <small style="color: var(--md-text-secondary); display: block; margin-top: 4px; font-size: 0.75rem; padding-left: var(--spacing-m);">Questo importo viene sottratto dallo 'Spendibile' ma non √® considerato risparmio formale.</small>
                    </div>
                    <button type="submit" class="btn btn-raised btn-secondary">Salva Obiettivi</button>
                </form>
            </section>
            <section class="card">
                <h2>üí∞ Gestione Entrate Principali</h2>
                <form id="main-income-form">
                     <div class="form-group"> <label for="main-income-desc">Descrizione Entrata (es. Stipendio, Tredicesima)</label>
                         <div class="text-field-container">
                            <input type="text" id="main-income-desc" required>
                             <div class="underline"></div>
                         </div>
                    </div>
                    <div class="form-group"> <label for="main-income-amount">Importo (‚Ç¨)</label>
                        <div class="text-field-container">
                            <input type="number" id="main-income-amount" step="0.01" min="0" required>
                             <div class="underline"></div>
                         </div>
                    </div>
                    <button type="submit" class="btn btn-raised btn-primary">Aggiungi Entrata Principale</button>
                </form>
                <ul id="main-income-list" class="item-list" style="margin-top: var(--spacing-l);">
                    <li style="color: var(--md-text-secondary); justify-content: center;">Nessuna entrata principale inserita per questo mese.</li>
                </ul>
                <div id="main-income-total" class="list-total" style="display: none;">
                    Totale Entrate Principali: <span>‚Ç¨ 0.00</span>
                 </div>
            </section>
            <section class="card">
                <h2>Spese Fisse Mensili</h2>
                <form id="fixed-expense-form">
                     <div class="form-group"> <label for="fixed-expense-name">Nome Spesa</label>
                         <div class="text-field-container">
                            <input type="text" id="fixed-expense-name" required>
                             <div class="underline"></div>
                         </div>
                    </div>
                     <div class="form-group"> <label for="fixed-expense-amount">Importo (‚Ç¨)</label>
                         <div class="text-field-container">
                            <input type="number" id="fixed-expense-amount" step="0.01" min="0" required>
                             <div class="underline"></div>
                        </div>
                    </div>
                    <div class="form-group"> <label for="fixed-expense-category">Categoria</label>
                         <div class="text-field-container">
                            <input type="text" id="fixed-expense-category" list="category-suggestions" required>
                             <div class="underline"></div>
                         </div>
                         <datalist id="category-suggestions">
                             </datalist>
                    </div>
                    <button type="submit" class="btn btn-raised btn-primary">Aggiungi Spesa Fissa</button>
                </form>

                <div class="sort-controls" style="margin-top: var(--spacing-l);">
                    <span>Ordina per:</span>
                    <button class="btn btn-text" data-sort="name">Nome</button>
                    <button class="btn btn-text" data-sort="category">Categoria</button>
                    <button class="btn btn-text" data-sort="amount">Costo</button>
                     <button class="btn btn-text" data-sort="default">Default</button>
                </div>

                <div id="fixed-expenses-list-container">
                    <p style="color: var(--md-text-secondary); text-align: center;">Nessuna spesa fissa inserita.</p>
                </div>
                 <div id="fixed-expenses-total" class="list-total" style="display: none;">
                    Totale Spese Fisse: <span>‚Ç¨ 0.00</span>
                 </div>
            </section>

            <section class="card">
                <h2>Entrate Extra del Mese</h2>
                <form id="extra-income-form">
                    <div class="form-group"> <label for="extra-income-desc">Descrizione</label>
                         <div class="text-field-container">
                            <input type="text" id="extra-income-desc" required>
                             <div class="underline"></div>
                         </div>
                    </div>
                    <div class="form-group"> <label for="extra-income-amount">Importo (‚Ç¨)</label>
                        <div class="text-field-container">
                            <input type="number" id="extra-income-amount" step="0.01" min="0" required>
                             <div class="underline"></div>
                         </div>
                    </div>
                    <button type="submit" class="btn btn-raised btn-primary">Aggiungi Entrata Extra</button>
                </form>
                <ul id="extra-income-list" class="item-list">
                    <li style="color: var(--md-text-secondary); justify-content: center;">Nessuna entrata extra inserita.</li>
                </ul>
                <div id="extra-income-total" class="list-total" style="display: none;">
                    Totale Entrate Extra: <span>‚Ç¨ 0.00</span>
                 </div>
            </section>

            <section class="card">
                <h2>Debiti/Accantonamenti per il Mese Prossimo</h2>
                 <p style="color: var(--md-text-secondary); font-size: 0.875rem; margin-bottom: var(--spacing-m);">
                     Inserisci qui importi spesi o promessi questo mese che verranno detratti dallo stipendio del *prossimo* mese (es. un prestito a breve termine, un acquisto importante da coprire dopo).
                 </p>
                <form id="debt-form">
                    <div class="form-group"> <label for="debt-desc">Descrizione Debito/Accantonamento</label>
                        <div class="text-field-container">
                            <input type="text" id="debt-desc" required>
                             <div class="underline"></div>
                         </div>
                    </div>
                    <div class="form-group"> <label for="debt-amount">Importo (‚Ç¨)</label>
                        <div class="text-field-container">
                            <input type="number" id="debt-amount" step="0.01" min="0" required>
                             <div class="underline"></div>
                         </div>
                    </div>
                    <button type="submit" class="btn btn-raised btn-primary">Aggiungi Debito/Acc.</button>
                </form>
                <ul id="debt-list" class="item-list">
                     <li style="color: var(--md-text-secondary); justify-content: center;">Nessun debito/accantonamento per il prossimo mese inserito.</li>
                </ul>
                 <div id="debt-total" class="list-total" style="display: none;">
                    Totale Debiti/Acc. per Mese Prossimo: <span>‚Ç¨ 0.00</span>
                 </div>
            </section>

            <section class="card">
                <h2>Impostazioni e Gestione Dati</h2>
                <div class="form-group">
                    <label for="backup-password">Password per Backup/Ripristino</label>
                     <div class="text-field-container">
                        <input type="password" id="backup-password" placeholder="Inserisci una password robusta" required>
                        <div class="underline"></div>
                     </div>
                    <small style="color: var(--md-text-secondary); display: block; margin-top: 4px; font-size: 0.75rem; padding-left: var(--spacing-m);">Necessaria per cifrare/decifrare il file di backup. Conservala!</small>
                </div>
                 <div class="form-group">
                    <button id="export-data" class="btn btn-outline">Esporta Backup Cifrato</button>
                 </div>
                 <hr style="border:none; border-bottom: 1px solid var(--md-divider); margin: var(--spacing-l) 0;">
                <div class="form-group">
                    <label for="import-file">Importa Backup Cifrato (.bbbackup)</label>
                     <div class="text-field-container">
                         <input type="file" id="import-file" accept=".bbbackup">
                     </div>
                </div>
                 <button id="import-data" class="btn btn-outline">Importa Dati</button>

                <hr style="border: none; border-bottom: 1px solid var(--md-divider); margin: var(--spacing-l) 0;">

                <button id="delete-all-data" class="btn btn-raised btn-danger">Cancella Tutti i Dati</button>
                <small style="color: var(--md-error); display: block; margin-top: var(--spacing-s); font-weight: bold; font-size: 0.875rem;">Attenzione: Questa azione √® irreversibile!</small>
            </section>
        </main>

    </div> <div id="notification">Messaggio notifica</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENT REFERENCES ---
            const themeSwitcher = document.getElementById('theme-switcher');
            const themeIcon = document.getElementById('theme-icon');
            const currentMonthDisplay = document.getElementById('current-month-display');

            // Summary elements
            const summarySalary = document.getElementById('summary-salary'); // Ora mostra Totale Entrate Principali
            const summarySavingsGoal = document.getElementById('summary-savings-goal');
            const summaryFixedTotal = document.getElementById('summary-fixed-total');
            const summaryExtraIncome = document.getElementById('summary-extra-income');
            const summaryPrevDebt = document.getElementById('summary-prev-debt');
            const summarySpendable = document.getElementById('summary-spendable');

            // Forms & Inputs (Aggiornati)
            const goalsForm = document.getElementById('goals-form'); // Nuovo form
            const savingsGoalInput = document.getElementById('savings-goal'); // Spostato
            const immediateDeductionInput = document.getElementById('immediate-deduction'); // Spostato

            const mainIncomeForm = document.getElementById('main-income-form'); // Nuovo form entrate principali
            const mainIncomeDescInput = document.getElementById('main-income-desc');
            const mainIncomeAmountInput = document.getElementById('main-income-amount');
            const mainIncomeList = document.getElementById('main-income-list'); // Nuova lista
            const mainIncomeTotalEl = document.getElementById('main-income-total').querySelector('span'); // Nuovo totale

            const fixedExpenseForm = document.getElementById('fixed-expense-form');
            const fixedExpenseNameInput = document.getElementById('fixed-expense-name');
            const fixedExpenseAmountInput = document.getElementById('fixed-expense-amount');
            const fixedExpenseCategoryInput = document.getElementById('fixed-expense-category');
            const categorySuggestions = document.getElementById('category-suggestions');
            const fixedExpensesListContainer = document.getElementById('fixed-expenses-list-container');
            const fixedExpensesTotalEl = document.getElementById('fixed-expenses-total').querySelector('span');
            const sortControls = document.querySelector('.sort-controls');

            const extraIncomeForm = document.getElementById('extra-income-form');
            const extraIncomeDescInput = document.getElementById('extra-income-desc');
            const extraIncomeAmountInput = document.getElementById('extra-income-amount');
            const extraIncomeList = document.getElementById('extra-income-list');
            const extraIncomeTotalEl = document.getElementById('extra-income-total').querySelector('span');

            const debtForm = document.getElementById('debt-form');
            const debtDescInput = document.getElementById('debt-desc');
            const debtAmountInput = document.getElementById('debt-amount');
            const debtList = document.getElementById('debt-list');
            const debtTotalEl = document.getElementById('debt-total').querySelector('span');

            // Settings & Data elements
            const backupPasswordInput = document.getElementById('backup-password');
            const exportButton = document.getElementById('export-data');
            const importFileInpit = document.getElementById('import-file'); // Typo nella variabile originale, corretto qui
            const importButton = document.getElementById('import-data');
            const deleteAllButton = document.getElementById('delete-all-data');

            // Notification element
            const notification = document.getElementById('notification');

             // --- FOCUS/BLUR for Underline Animation ---
             const inputs = document.querySelectorAll('.text-field-container input');
             inputs.forEach(input => {
                 input.addEventListener('focus', () => {
                    input.parentElement.classList.add('focused'); // Classe non usata, ma potenzialmente utile
                    input.parentElement.querySelector('.underline')?.classList.add('active'); // Anima linea
                 });
                 input.addEventListener('blur', () => {
                     input.parentElement.classList.remove('focused');
                     input.parentElement.querySelector('.underline')?.classList.remove('active'); // Rimuovi animazione linea
                 });
             });


            // --- APPLICATION STATE (Nuova Struttura) ---
            let appData = {
                monthHistory: {}, // Oggetto per storico { "AAAA-MM": { dati mese } }
                settings: {
                    theme: 'light',
                    fixedExpensesSort: 'default',
                }
            };

             // --- UTILITY FUNCTIONS (Invariate) ---
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(amount || 0);
            };

            const generateId = () => {
                return Date.now().toString(36) + Math.random().toString(36).substring(2);
            };

             const showNotification = (message, type = 'info', duration = 3000) => {
                notification.textContent = message;
                notification.className = '';
                notification.classList.add('show');
                if (type === 'error') { notification.classList.add('error'); }
                else if (type === 'success') { notification.classList.add('success'); }
                setTimeout(() => { notification.classList.remove('show'); }, duration);
            };

            // --- HELPER FUNCTIONS per la Nuova Struttura ---
            const getCurrentYearMonth = () => {
                const now = new Date();
                return `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
            };

             const getPreviousYearMonth = (currentYYYYMM) => {
                if (!currentYYYYMM || typeof currentYYYYMM !== 'string' || !currentYYYYMM.includes('-')) { return null; }
                const parts = currentYYYYMM.split('-');
                let year = parseInt(parts[0], 10);
                let month = parseInt(parts[1], 10);
                month--;
                if (month === 0) { month = 12; year--; }
                return `${year}-${month.toString().padStart(2, '0')}`;
            };

             const getCurrentMonthData = (createIfNeeded = true) => {
                const currentYYYYMM = getCurrentYearMonth();
                if (!appData.monthHistory) { appData.monthHistory = {}; } // Sicurezza extra

                if (!appData.monthHistory[currentYYYYMM] && createIfNeeded) {
                    appData.monthHistory[currentYYYYMM] = {
                        mainIncomes: [], savingsGoal: 0, immediateDeduction: 0,
                        fixedExpenses: [], extraIncome: [], debtsIncurred: []
                    };
                    console.log(`Inizializzati dati per il mese: ${currentYYYYMM}`);

                    // Copia spese fisse dal mese precedente se esiste
                    const prevYYYYMM = getPreviousYearMonth(currentYYYYMM);
                    if (appData.monthHistory[prevYYYYMM] && appData.monthHistory[prevYYYYMM].fixedExpenses) {
                        try {
                            // Deep copy JSON per evitare riferimento diretto all'array precedente
                             appData.monthHistory[currentYYYYMM].fixedExpenses = JSON.parse(JSON.stringify(appData.monthHistory[prevYYYYMM].fixedExpenses));
                             console.log(`Copiate ${appData.monthHistory[currentYYYYMM].fixedExpenses.length} spese fisse da ${prevYYYYMM}`);
                        } catch (e) {
                             console.error("Errore nella copia profonda delle spese fisse:", e);
                             appData.monthHistory[currentYYYYMM].fixedExpenses = []; // Fallback a vuoto
                        }
                    }
                }
                // Ritorna i dati del mese corrente (o undefined se non esiste e createIfNeeded √® false)
                return appData.monthHistory[currentYYYYMM];
            };


            // --- DATA PERSISTENCE (LocalStorage - Invariato nel concetto) ---
            const saveData = () => {
                try {
                    localStorage.setItem('budgetBulldogDataMaterial', JSON.stringify(appData));
                    console.log("Data saved successfully (Material - Storico).");
                } catch (error) {
                    console.error("Error saving data to localStorage:", error);
                    showNotification("Errore nel salvataggio dei dati!", 'error');
                }
            };

            const loadData = () => {
                const savedData = localStorage.getItem('budgetBulldogDataMaterial');
                let needsSave = false; // Flag per salvare se inizializziamo dati
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                         // Migrazione MOLTO basilare: Se trova la vecchia struttura, la ignora
                         // Una migrazione reale sarebbe pi√π complessa
                        if (parsedData && parsedData.monthHistory && parsedData.settings) {
                            appData = parsedData;
                            console.log("Data loaded (Material - Storico):", appData);
                        } else {
                             console.warn("Struttura dati vecchia o non valida rilevata. Inizializzazione con nuova struttura.");
                             // appData rimane quella di default con monthHistory vuoto
                             needsSave = true; // Salva la nuova struttura vuota
                        }

                    } catch (error) {
                        console.error("Error parsing data from localStorage:", error);
                        showNotification("Errore nel caricamento dei dati salvati. Verranno usati i valori predefiniti.", 'error', 5000);
                         // appData rimane quella di default
                         needsSave = true; // Salva la struttura di default
                    }
                } else {
                    console.log("No saved data found, initialized default state (Material - Storico).");
                    // appData √® gi√† quella di default
                    needsSave = true; // Salva la struttura di default
                }

                 // Assicura che settings esista sempre
                 if (!appData.settings) {
                     appData.settings = { theme: 'light', fixedExpensesSort: 'default' };
                     needsSave = true;
                 }
                 if (!appData.monthHistory) {
                    appData.monthHistory = {};
                    needsSave = true;
                 }

                // Assicura che i dati del mese corrente esistano (li crea se necessario)
                getCurrentMonthData(true); // Forza la creazione se non esiste

                if(needsSave) {
                    saveData(); // Salva solo se abbiamo dovuto inizializzare/correggere
                }
            };

            // --- CRYPTO FUNCTIONS (Invariate) ---
            const getPasswordKey = async (password) => {
                const enc = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]);
                const salt = enc.encode("BudgetBulldogSalt");
                return window.crypto.subtle.deriveKey({ name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" }, keyMaterial, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
            };
            const encryptData = async (key, data) => {
                const enc = new TextEncoder();
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const encodedData = enc.encode(JSON.stringify(data));
                const ciphertext = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, encodedData);
                 const ivString = btoa(String.fromCharCode.apply(null, iv));
                 const cipherString = btoa(String.fromCharCode.apply(null, new Uint8Array(ciphertext)));
                return { iv: ivString, cipher: cipherString };
            };
             const decryptData = async (key, encryptedPayload) => {
                const { iv: ivString, cipher: cipherString } = encryptedPayload;
                if (!ivString || !cipherString) throw new Error("Invalid encrypted payload structure");
                 const iv = Uint8Array.from(atob(ivString), c => c.charCodeAt(0));
                 const ciphertext = Uint8Array.from(atob(cipherString), c => c.charCodeAt(0)).buffer;
                const dec = new TextDecoder();
                try {
                    const decrypted = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, ciphertext);
                    return JSON.parse(dec.decode(decrypted));
                } catch (error) { console.error("Decryption failed:", error); throw new Error("Decryption failed. Password errata o file corrotto."); }
            };


            // --- RENDERING FUNCTIONS ---
            const renderTheme = () => {
                if (appData.settings.theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeIcon.textContent = 'dark_mode';
                } else {
                    document.body.classList.remove('dark-mode');
                    themeIcon.textContent = 'light_mode';
                }
            };

            // NUOVA: Renderizza lista entrate principali
            const renderMainIncomes = () => {
                const currentData = getCurrentMonthData(false); // Non creare se non esiste qui
                const incomes = currentData?.mainIncomes || []; // Usa array vuoto se non ci sono dati
                mainIncomeList.innerHTML = '';
                let totalMain = 0;

                if (incomes.length === 0) {
                    mainIncomeList.innerHTML = '<li style="color: var(--md-text-secondary); justify-content: center;">Nessuna entrata principale inserita per questo mese.</li>';
                    document.getElementById('main-income-total').style.display = 'none';
                } else {
                    incomes.forEach(income => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div class="item-details">
                                <span class="item-name">${income.description || 'N/D'}</span>
                            </div>
                            <span class="item-amount">${formatCurrency(income.amount)}</span>
                            <button class="btn-delete-item" data-id="${income.id}" title="Elimina">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        `;
                        li.querySelector('button').addEventListener('click', handleDeleteMainIncome);
                        mainIncomeList.appendChild(li);
                        totalMain += Number(income.amount || 0);
                    });
                    mainIncomeTotalEl.textContent = formatCurrency(totalMain);
                    document.getElementById('main-income-total').style.display = 'block';
                }
            };

            // AGGIORNATA: Usa getCurrentMonthData
            const renderFixedExpenses = () => {
                const currentData = getCurrentMonthData(false); // Non creare se non esiste
                const expenses = currentData?.fixedExpenses || [];
                const sortType = appData.settings.fixedExpensesSort || 'default';
                let sortedExpenses = [...expenses];

                 if (sortType === 'name') sortedExpenses.sort((a, b) => a.name.localeCompare(b.name));
                 else if (sortType === 'category') sortedExpenses.sort((a, b) => { const c=a.category.localeCompare(b.category); return c !== 0 ? c : a.name.localeCompare(b.name); });
                 else if (sortType === 'amount') sortedExpenses.sort((a, b) => Number(b.amount) - Number(a.amount));

                 fixedExpensesListContainer.innerHTML = '';
                 const categories = [...new Set(expenses.map(exp => exp.category))].sort();
                 categorySuggestions.innerHTML = categories.map(cat => `<option value="${cat}">`).join('');
                 let totalFixed = 0;

                if (sortedExpenses.length === 0) {
                    fixedExpensesListContainer.innerHTML = '<p style="color: var(--md-text-secondary); text-align: center;">Nessuna spesa fissa inserita.</p>';
                    document.getElementById('fixed-expenses-total').style.display = 'none';
                } else {
                     if (sortType === 'category') {
                         const expensesByCategory = sortedExpenses.reduce((groups, expense) => {
                            const category = expense.category || 'Senza Categoria';
                            if (!groups[category]) groups[category] = { items: [], total: 0 };
                            groups[category].items.push(expense);
                            groups[category].total += Number(expense.amount || 0);
                            return groups;
                          }, {});
                         const sortedCategories = Object.keys(expensesByCategory).sort();
                         sortedCategories.forEach(category => {
                            const group = expensesByCategory[category];
                             const categoryContainer = document.createElement('div');
                             categoryContainer.className = 'category-subtotal';
                             categoryContainer.innerHTML = `<h4>${category}</h4>`;
                             const ul = document.createElement('ul');
                             ul.className = 'item-list';
                             group.items.forEach(expense => { ul.appendChild(createFixedExpenseListItem(expense)); totalFixed += Number(expense.amount || 0); });
                             categoryContainer.appendChild(ul);
                             categoryContainer.innerHTML += `<div class="category-subtotal-amount">Subtotale: <span>${formatCurrency(group.total)}</span></div>`;
                              fixedExpensesListContainer.appendChild(categoryContainer);
                         });
                    } else {
                        const ul = document.createElement('ul');
                        ul.className = 'item-list';
                         sortedExpenses.forEach(expense => { ul.appendChild(createFixedExpenseListItem(expense)); totalFixed += Number(expense.amount || 0); });
                         fixedExpensesListContainer.appendChild(ul);
                     }
                    fixedExpensesTotalEl.textContent = formatCurrency(totalFixed);
                    document.getElementById('fixed-expenses-total').style.display = 'block';
                }
             };

             // Helper (invariato)
             const createFixedExpenseListItem = (expense) => {
                const li = document.createElement('li');
                 li.innerHTML = `
                    <div class="item-details">
                        <span class="item-name">${expense.name || 'N/D'}</span>
                         ${expense.category ? `<span class="item-category">(${expense.category})</span>` : ''}
                    </div>
                    <span class="item-amount">${formatCurrency(expense.amount)}</span>
                    <button class="btn-delete-item" data-id="${expense.id}" title="Elimina">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                 `;
                 li.querySelector('button').addEventListener('click', handleDeleteFixedExpense);
                 return li;
             };

            // AGGIORNATA: Usa getCurrentMonthData
            const renderExtraIncome = () => {
                const currentData = getCurrentMonthData(false);
                const incomes = currentData?.extraIncome || [];
                extraIncomeList.innerHTML = '';
                let totalExtra = 0;
                if (incomes.length === 0) {
                     extraIncomeList.innerHTML = '<li style="color: var(--md-text-secondary); justify-content: center;">Nessuna entrata extra inserita.</li>';
                     document.getElementById('extra-income-total').style.display = 'none';
                } else {
                    incomes.forEach(income => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div class="item-details"><span class="item-name">${income.description || 'N/D'}</span></div>
                            <span class="item-amount">${formatCurrency(income.amount)}</span>
                            <button class="btn-delete-item" data-id="${income.id}" title="Elimina">
                                <span class="material-symbols-outlined">delete</span>
                            </button>`;
                         li.querySelector('button').addEventListener('click', handleDeleteExtraIncome);
                        extraIncomeList.appendChild(li);
                         totalExtra += Number(income.amount || 0);
                    });
                    extraIncomeTotalEl.textContent = formatCurrency(totalExtra);
                    document.getElementById('extra-income-total').style.display = 'block';
                }
            };

            // AGGIORNATA: Usa getCurrentMonthData
            const renderDebts = () => {
                 const currentData = getCurrentMonthData(false);
                 const debts = currentData?.debtsIncurred || [];
                 debtList.innerHTML = '';
                 let totalDebt = 0;
                if (debts.length === 0) {
                     debtList.innerHTML = '<li style="color: var(--md-text-secondary); justify-content: center;">Nessun debito/accantonamento per il prossimo mese inserito.</li>';
                     document.getElementById('debt-total').style.display = 'none';
                } else {
                    debts.forEach(debt => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div class="item-details"><span class="item-name">${debt.description || 'N/D'}</span></div>
                            <span class="item-amount">${formatCurrency(debt.amount)}</span>
                             <button class="btn-delete-item" data-id="${debt.id}" title="Elimina">
                                <span class="material-symbols-outlined">delete</span>
                            </button>`;
                        li.querySelector('button').addEventListener('click', handleDeleteDebt);
                        debtList.appendChild(li);
                        totalDebt += Number(debt.amount || 0);
                    });
                     debtTotalEl.textContent = formatCurrency(totalDebt);
                     document.getElementById('debt-total').style.display = 'block';
                }
            };

            // AGGIORNATA: Calcola tutto con la nuova struttura
            const renderSummary = () => {
                const currentData = getCurrentMonthData(false); // Prendi dati correnti (non crearli se mancano qui)
                const currentYYYYMM = getCurrentYearMonth();

                // Se non ci sono dati per il mese corrente (es. primo avvio assoluto), mostra 0
                if (!currentData) {
                     currentMonthDisplay.textContent = 'N/D';
                     summarySalary.textContent = formatCurrency(0);
                     summarySavingsGoal.textContent = formatCurrency(0);
                     summaryFixedTotal.textContent = formatCurrency(0);
                     summaryExtraIncome.textContent = formatCurrency(0);
                     summaryPrevDebt.textContent = formatCurrency(0);
                     summarySpendable.textContent = formatCurrency(0);
                    summarySpendable.classList.remove('negative');
                     return; // Esci se non ci sono dati per il mese
                }

                // Calcola totale entrate principali
                const totalMainIncome = (currentData.mainIncomes || []).reduce((sum, inc) => sum + Number(inc.amount || 0), 0);

                // Altri totali
                const totalFixedExpenses = (currentData.fixedExpenses || []).reduce((sum, exp) => sum + Number(exp.amount || 0), 0);
                const totalExtraIncome = (currentData.extraIncome || []).reduce((sum, inc) => sum + Number(inc.amount || 0), 0);

                // Obiettivi
                const savingsGoal = Number(currentData.savingsGoal) || 0;
                const immediateDeduction = Number(currentData.immediateDeduction) || 0;

                // Calcola debiti mese precedente
                const prevYYYYMM = getPreviousYearMonth(currentYYYYMM);
                let prevDebt = 0;
                if (appData.monthHistory && appData.monthHistory[prevYYYYMM] && appData.monthHistory[prevYYYYMM].debtsIncurred) {
                    prevDebt = appData.monthHistory[prevYYYYMM].debtsIncurred.reduce((sum, debt) => sum + Number(debt.amount || 0), 0);
                }

                // Calcola spendibile
                const spendable = totalMainIncome + totalExtraIncome - savingsGoal - immediateDeduction - totalFixedExpenses - prevDebt;

                // --- Aggiorna Testo Riepilogo ---
                const nomiMesi = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
                let displayDate = 'N/D';
                if (currentYYYYMM && typeof currentYYYYMM === 'string') {
                    const parts = currentYYYYMM.split('-');
                    if (parts.length === 2) {
                        const year = parseInt(parts[0], 10); const monthIndex = parseInt(parts[1], 10) - 1;
                        if (!isNaN(year) && monthIndex >= 0 && monthIndex < 12) { displayDate = `${nomiMesi[monthIndex]} ${year}`; }
                        else { displayDate = currentYYYYMM; }
                    } else { displayDate = currentYYYYMM; }
                }
                currentMonthDisplay.textContent = displayDate;

                // Aggiorna valori
                summarySalary.textContent = formatCurrency(totalMainIncome);
                summarySavingsGoal.textContent = formatCurrency(savingsGoal);
                summaryFixedTotal.textContent = formatCurrency(totalFixedExpenses);
                summaryExtraIncome.textContent = formatCurrency(totalExtraIncome);
                summaryPrevDebt.textContent = formatCurrency(prevDebt);
                summarySpendable.textContent = formatCurrency(spendable);
                summarySpendable.classList.toggle('negative', spendable < 0);
            };

            // AGGIORNATA: Popola campi obiettivi e chiama nuovo render entrate
            const renderAll = () => {
                const currentData = getCurrentMonthData(false); // Prendi dati correnti (non crearli)

                 // Popola i campi del form Obiettivi solo se ci sono dati per il mese
                 if(currentData) {
                     savingsGoalInput.value = currentData.savingsGoal || 0;
                     immediateDeductionInput.value = currentData.immediateDeduction || 0;
                 } else {
                     // Se non ci sono dati per il mese, svuota i campi obiettivi
                     savingsGoalInput.value = '';
                     immediateDeductionInput.value = '';
                 }

                // Renderizza le altre sezioni
                renderTheme();
                renderMainIncomes(); // Renderizza lista entrate principali
                renderFixedExpenses();
                renderExtraIncome();
                renderDebts();
                renderSummary(); // Render summary per ultimo
            };

            // --- EVENT HANDLERS ---
            themeSwitcher.addEventListener('click', () => {
                appData.settings.theme = (appData.settings.theme === 'light') ? 'dark' : 'light';
                saveData();
                renderTheme();
                showNotification(`Tema ${appData.settings.theme === 'dark' ? 'Scuro' : 'Chiaro'} attivato`, 'success', 1500);
            });

            // NUOVO Handler per Form Obiettivi
            goalsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const currentData = getCurrentMonthData(true); // Assicura che i dati mese esistano
                currentData.savingsGoal = parseFloat(savingsGoalInput.value) || 0;
                currentData.immediateDeduction = parseFloat(immediateDeductionInput.value) || 0;
                saveData();
                renderSummary();
                showNotification("Obiettivi mensili salvati.", 'success');
            });

            // NUOVO Handler per Form Entrate Principali
            mainIncomeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const description = mainIncomeDescInput.value.trim();
                const amount = parseFloat(mainIncomeAmountInput.value);
                const currentData = getCurrentMonthData(true); // Assicura che i dati mese esistano

                if (description && amount > 0) {
                    const newIncome = { id: generateId(), description: description, amount: amount };
                    if (!currentData.mainIncomes) currentData.mainIncomes = [];
                    currentData.mainIncomes.push(newIncome);
                    saveData();
                    renderMainIncomes();
                    renderSummary();
                    mainIncomeForm.reset();
                    mainIncomeDescInput.focus();
                    showNotification("Entrata principale aggiunta.", 'success');
                } else {
                    showNotification("Per favore, compila descrizione e importo valido.", 'error');
                }
            });

             // NUOVO Handler per Eliminare Entrata Principale
             function handleDeleteMainIncome(e) {
                const button = e.target.closest('button');
                if (!button) return;
                const incomeId = button.dataset.id;
                const currentData = getCurrentMonthData(false); // Prendi dati correnti

                if (currentData && currentData.mainIncomes) {
                     currentData.mainIncomes = currentData.mainIncomes.filter(inc => inc.id !== incomeId);
                     saveData();
                     renderMainIncomes();
                     renderSummary();
                     showNotification("Entrata principale eliminata.", 'success');
                 }
            }


            // Handler Spese Fisse (Form e Ordinamento invariati nel trigger, aggiornati nell'implementazione)
            fixedExpenseForm.addEventListener('submit', (e) => {
                 e.preventDefault();
                 const name = fixedExpenseNameInput.value.trim();
                 const amount = parseFloat(fixedExpenseAmountInput.value);
                 const category = fixedExpenseCategoryInput.value.trim();
                 const currentData = getCurrentMonthData(true); // Usa dati correnti

                 if (name && amount > 0 && category) {
                    const newExpense = { id: generateId(), name: name, amount: amount, category: category };
                    if (!currentData.fixedExpenses) currentData.fixedExpenses = [];
                    currentData.fixedExpenses.push(newExpense);
                    saveData();
                    renderFixedExpenses(); renderSummary();
                    fixedExpenseForm.reset(); fixedExpenseNameInput.focus();
                     showNotification("Spesa fissa aggiunta.", 'success');
                 } else { showNotification("Per favore, compila tutti i campi della spesa fissa.", 'error'); }
             });

             sortControls.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.sort) {
                    appData.settings.fixedExpensesSort = e.target.dataset.sort;
                     sortControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                     e.target.classList.add('active');
                     saveData(); // Salva preferenza sort
                     renderFixedExpenses(); // Rerender lista
                 }
             });

            // Handler Eliminazione Spesa Fissa (Aggiornato)
            function handleDeleteFixedExpense(e) {
                 const button = e.target.closest('button');
                 if (!button) return;
                 const expenseId = button.dataset.id;
                 const currentData = getCurrentMonthData(false); // Usa dati correnti

                 if(currentData && currentData.fixedExpenses) {
                    currentData.fixedExpenses = currentData.fixedExpenses.filter(exp => exp.id !== expenseId);
                    saveData();
                    renderFixedExpenses();
                    renderSummary();
                    showNotification("Spesa fissa eliminata.", 'success');
                 }
            }

             // Handler Entrate Extra (Form invariato nel trigger, aggiornato nell'implementazione)
             extraIncomeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                 const description = extraIncomeDescInput.value.trim();
                 const amount = parseFloat(extraIncomeAmountInput.value);
                 const currentData = getCurrentMonthData(true); // Usa dati correnti

                 if (description && amount > 0) {
                     const newIncome = { id: generateId(), description, amount };
                     if (!currentData.extraIncome) currentData.extraIncome = [];
                     currentData.extraIncome.push(newIncome);
                     saveData(); renderExtraIncome(); renderSummary();
                     extraIncomeForm.reset(); extraIncomeDescInput.focus();
                      showNotification("Entrata extra aggiunta.", 'success');
                 } else { showNotification("Per favore, compila tutti i campi dell'entrata extra.", 'error'); }
              });

            // Handler Eliminazione Entrata Extra (Aggiornato)
            function handleDeleteExtraIncome(e) {
                 const button = e.target.closest('button');
                 if (!button) return;
                const incomeId = button.dataset.id;
                const currentData = getCurrentMonthData(false); // Usa dati correnti

                if(currentData && currentData.extraIncome) {
                    currentData.extraIncome = currentData.extraIncome.filter(inc => inc.id !== incomeId);
                    saveData(); renderExtraIncome(); renderSummary();
                    showNotification("Entrata extra eliminata.", 'success');
                }
            }

             // Handler Debiti (Form invariato nel trigger, aggiornato nell'implementazione)
             debtForm.addEventListener('submit', (e) => {
                 e.preventDefault();
                 const description = debtDescInput.value.trim();
                 const amount = parseFloat(debtAmountInput.value);
                 const currentData = getCurrentMonthData(true); // Usa dati correnti

                 if (description && amount > 0) {
                     const newDebt = { id: generateId(), description, amount };
                     if (!currentData.debtsIncurred) currentData.debtsIncurred = [];
                     currentData.debtsIncurred.push(newDebt);
                     saveData(); renderDebts();
                     debtForm.reset(); debtDescInput.focus();
                      showNotification("Debito/Accantonamento aggiunto per il prossimo mese.", 'success');
                 } else { showNotification("Per favore, compila tutti i campi del debito/accantonamento.", 'error'); }
             });

            // Handler Eliminazione Debito (Aggiornato)
            function handleDeleteDebt(e) {
                 const button = e.target.closest('button');
                 if (!button) return;
                const debtId = button.dataset.id;
                const currentData = getCurrentMonthData(false); // Usa dati correnti

                if(currentData && currentData.debtsIncurred) {
                    currentData.debtsIncurred = currentData.debtsIncurred.filter(debt => debt.id !== debtId);
                    saveData(); renderDebts();
                    showNotification("Debito/Accantonamento eliminato.", 'success');
                }
            }

            // Handler Export (Invariato nel concetto, esporta tutta appData)
             exportButton.addEventListener('click', async () => {
                 const password = backupPasswordInput.value;
                 if (!password) { showNotification("Inserisci una password per creare il backup.", 'error'); backupPasswordInput.focus(); return; }
                 try {
                     const key = await getPasswordKey(password);
                     // Esporta l'intero oggetto appData che ora contiene lo storico
                     const encryptedPayload = await encryptData(key, appData);
                     const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(encryptedPayload));
                     const downloadAnchorNode = document.createElement('a');
                     const filename = `budget_bulldog_material_backup_${getCurrentYearMonth()}_${Date.now()}.bbbackup`;
                     downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", filename);
                     document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove();
                      showNotification("Backup esportato con successo!", 'success'); backupPasswordInput.value = '';
                 } catch (error) { console.error("Export error:", error); showNotification(`Errore durante l'esportazione: ${error.message}`, 'error', 5000); }
             });

            // Handler Import (Invariato nel concetto, importa in appData)
            importButton.addEventListener('click', () => {
                 const file = importFileInpit.files[0]; const password = backupPasswordInput.value;
                 if (!file) { showNotification("Seleziona un file di backup (.bbbackup).", 'error'); return; }
                 if (!password) { showNotification("Inserisci la password usata per creare questo backup.", 'error'); backupPasswordInput.focus(); return; }
                 const reader = new FileReader();
                 reader.onload = async (event) => {
                     try {
                         const encryptedPayload = JSON.parse(event.target.result); const key = await getPasswordKey(password);
                         const decryptedData = await decryptData(key, encryptedPayload);
                         // Valida che i dati importati abbiano almeno la struttura base attesa
                         if (decryptedData && decryptedData.monthHistory && decryptedData.settings) {
                             appData = decryptedData; // Sovrascrive stato corrente
                             saveData();
                             loadData(); // Ricarica per assicurare consistenza (es. creazione dati mese corrente se mancanti)
                             renderAll();
                             showNotification("Dati importati con successo!", 'success');
                             importFileInpit.value = ''; backupPasswordInput.value = '';
                         } else { throw new Error("Il file di backup non sembra contenere dati validi (manca monthHistory o settings)."); }
                     } catch (error) { console.error("Import error:", error); showNotification(`Errore durante l'importazione: ${error.message}`, 'error', 5000); }
                 };
                 reader.onerror = () => { showNotification("Errore nella lettura del file.", 'error'); };
                 reader.readAsText(file);
            });

            // Handler Delete All (Invariato nel concetto, rimuove la chiave)
             deleteAllButton.addEventListener('click', () => {
                if (confirm("SEI SICURO?\nTutti i tuoi dati (incluso lo storico) verranno cancellati PERMANENTEMENTE da questo dispositivo. Questa azione non pu√≤ essere annullata.")) {
                     if (confirm("CONFERMA DEFINITIVA?\nNon ci sar√† modo di recuperare i dati dopo questa conferma.")) {
                         localStorage.removeItem('budgetBulldogDataMaterial');
                         // Resetta lo stato in memoria a quello iniziale
                         appData = {
                             monthHistory: {},
                             settings: { theme: 'light', fixedExpensesSort: 'default' }
                         };
                         getCurrentMonthData(true); // Crea dati vuoti per il mese corrente
                         saveData(); // Salva lo stato resettato
                         renderAll(); // Rirenderizza tutto (mostrer√† vuoto)
                         // Svuota anche i form non resettati automaticamente da renderAll
                         goalsForm.reset();
                         mainIncomeForm.reset();
                         fixedExpenseForm.reset();
                         extraIncomeForm.reset();
                         debtForm.reset();
                         backupPasswordInput.value = '';

                         showNotification("Tutti i dati sono stati cancellati.", 'success', 5000);
                     }
                 }
             });

            // --- INITIALIZATION ---
            loadData(); // Carica i dati (o inizializza la nuova struttura)
            renderAll(); // Renderizza l'interfaccia iniziale

             // Imposta stato iniziale bottoni sort (invariato)
             const currentSort = appData.settings.fixedExpensesSort || 'default';
             sortControls.querySelectorAll('button').forEach(btn => {
                 if (btn.dataset.sort === currentSort) { btn.classList.add('active'); }
                 else { btn.classList.remove('active'); }
             });

        }); // End DOMContentLoaded
    </script>

</body>
</html>